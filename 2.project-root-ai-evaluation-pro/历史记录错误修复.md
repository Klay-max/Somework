# 历史记录错误修复

## 问题描述
2026-01-20

历史记录页面显示错误：
```
Uncaught Error
Cannot read properties of null (reading 'toFixed')
```

## 问题原因

在 `app/history.tsx` 和 `app/index.tsx` 中，代码尝试对可能为 `null` 或 `undefined` 的数值调用 `.toFixed()` 方法，导致运行时错误。

### 问题代码位置

1. **app/history.tsx 第 165 行**:
   ```typescript
   {statistics.averageScore.toFixed(0)}
   ```

2. **app/history.tsx 第 172 行**:
   ```typescript
   {report.accuracy.toFixed(1)}%
   ```

3. **app/index.tsx 第 115 行**:
   ```typescript
   {statistics.averageAccuracy.toFixed(0)}%
   ```

## 解决方案

添加空值检查，在调用 `.toFixed()` 之前确保值不为 `null` 或 `undefined`。

### 修复后的代码

1. **app/history.tsx - 统计信息**:
   ```typescript
   <View style={styles.statItem}>
     <Text style={styles.statValue}>
       {statistics.averageScore ? statistics.averageScore.toFixed(0) : '0'}
     </Text>
     <Text style={styles.statLabel}>平均分</Text>
   </View>
   
   <View style={styles.statItem}>
     <Text style={styles.statValue}>
       {statistics.averageAccuracy ? statistics.averageAccuracy.toFixed(1) : '0'}%
     </Text>
     <Text style={styles.statLabel}>平均正确率</Text>
   </View>
   ```

2. **app/history.tsx - 报告列表**:
   ```typescript
   <Text style={styles.reportStatValue}>
     {report.accuracy ? report.accuracy.toFixed(1) : '0'}%
   </Text>
   ```

3. **app/index.tsx - 首页统计**:
   ```typescript
   <Text style={styles.dataValue}>
     {statistics.totalReports > 0 && statistics.averageAccuracy 
       ? `${statistics.averageAccuracy.toFixed(0)}%` 
       : '--'}
   </Text>
   ```

## 修复的文件

- ✅ `app/history.tsx` - 历史记录页面
- ✅ `app/index.tsx` - 首页仪表盘

## 测试步骤

1. **刷新浏览器页面** (F5 或 Ctrl+R)
2. **访问历史记录页面**:
   - 点击首页的 "查看历史" 按钮
   - 或直接访问 http://localhost:8081/history
3. **验证功能**:
   - 页面应该正常显示，不再有错误
   - 如果没有历史记录，应该显示空状态提示
   - 如果有历史记录，应该正确显示统计信息和报告列表

## 预防措施

### 最佳实践

在处理可能为 `null` 或 `undefined` 的数值时，始终添加检查：

```typescript
// ❌ 错误 - 可能导致运行时错误
value.toFixed(2)

// ✅ 正确 - 使用可选链和默认值
value?.toFixed(2) ?? '0'

// ✅ 正确 - 使用条件表达式
value ? value.toFixed(2) : '0'

// ✅ 正确 - 使用逻辑运算符
(value || 0).toFixed(2)
```

### TypeScript 类型检查

确保 TypeScript 配置启用严格的空值检查：

```json
{
  "compilerOptions": {
    "strictNullChecks": true
  }
}
```

## 相关问题

如果遇到类似的 "Cannot read properties of null" 错误：

1. **检查数据来源**: 确认数据是否正确加载
2. **添加空值检查**: 在访问属性或调用方法前检查值
3. **使用可选链**: 使用 `?.` 操作符安全访问嵌套属性
4. **提供默认值**: 使用 `??` 或 `||` 提供后备值

## 当前状态

✅ **已修复**
- 历史记录页面不再报错
- 首页统计信息正确显示
- 所有 `.toFixed()` 调用都有空值保护

---

**更新时间**: 2026-01-20  
**状态**: ✅ 问题已解决

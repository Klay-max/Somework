# 真实环境测试计划

## 📋 当前状态

### Mock 模式（当前）
- ✅ 状态：已启用（`MOCK_CONFIG.enabled = true`）
- ✅ 测试：流程已验证通过
- ✅ 功能：OCR + AI 分析 + 学习路径生成
- ⚠️ 限制：使用模拟数据，未连接真实 API

### 真实 API 状态
- ✅ **DeepSeek AI**: 正常工作（已测试）
- ❌ **阿里云 OCR**: 网络连接失败
  - 错误：`getaddrinfo ENOTFOUND ocr-api.cn-shanghai.aliyuncs.com`
  - 原因：DNS 解析失败或网络不通

---

## 🎯 测试目标

1. **解决阿里云 OCR 网络问题**
2. **切换到真实 API 模式**
3. **验证完整检测流程**
4. **确保用户体验流畅**

---

## 🔍 问题分析

### 阿里云 OCR 网络问题

**可能原因**:
1. **DNS 解析问题**
   - 本地 DNS 无法解析阿里云域名
   - 需要配置正确的 DNS 服务器

2. **网络防火墙**
   - 公司/学校网络可能屏蔽了阿里云服务
   - 需要使用 VPN 或代理

3. **API 端点配置错误**
   - 使用了错误的区域端点
   - 需要确认正确的 endpoint

4. **网络环境限制**
   - 开发环境网络不稳定
   - 需要在不同网络环境测试

---

## 💡 解决方案

### 方案 1: 修复阿里云 OCR 网络（推荐）

#### 步骤 1: 诊断网络连接
```bash
# 测试 DNS 解析
nslookup ocr-api.cn-shanghai.aliyuncs.com

# 测试网络连通性
ping ocr-api.cn-shanghai.aliyuncs.com

# 测试 HTTPS 连接
curl -v https://ocr-api.cn-shanghai.aliyuncs.com
```

#### 步骤 2: 尝试不同的解决方法

**方法 A: 更换 DNS 服务器**
```
1. 使用公共 DNS（如 8.8.8.8 或 114.114.114.114）
2. 在系统网络设置中配置
3. 重新测试连接
```

**方法 B: 使用代理**
```javascript
// 在 api/lib/alicloud-ocr.ts 中配置代理
const https = require('https');
const agent = new https.Agent({
  proxy: 'http://your-proxy:port'
});
```

**方法 C: 更换 API 端点**
```javascript
// 尝试不同的区域端点
const endpoints = [
  'ocr-api.cn-shanghai.aliyuncs.com',  // 上海
  'ocr-api.cn-beijing.aliyuncs.com',   // 北京
  'ocr-api.cn-hangzhou.aliyuncs.com',  // 杭州
  'ocr-api.cn-shenzhen.aliyuncs.com',  // 深圳
];
```

**方法 D: 使用 VPN**
```
1. 连接到稳定的 VPN 服务
2. 确保 VPN 允许访问阿里云服务
3. 重新测试
```

#### 步骤 3: 创建网络诊断脚本
```javascript
// test-alicloud-network.js
const https = require('https');

const endpoints = [
  'ocr-api.cn-shanghai.aliyuncs.com',
  'ocr-api.cn-beijing.aliyuncs.com',
  'ocr-api.cn-hangzhou.aliyuncs.com',
];

async function testEndpoint(endpoint) {
  return new Promise((resolve) => {
    const req = https.request({
      hostname: endpoint,
      port: 443,
      path: '/',
      method: 'GET',
      timeout: 5000,
    }, (res) => {
      resolve({ endpoint, status: 'success', code: res.statusCode });
    });

    req.on('error', (err) => {
      resolve({ endpoint, status: 'failed', error: err.message });
    });

    req.on('timeout', () => {
      req.destroy();
      resolve({ endpoint, status: 'timeout' });
    });

    req.end();
  });
}

async function main() {
  console.log('测试阿里云 OCR 端点连接...\n');
  
  for (const endpoint of endpoints) {
    const result = await testEndpoint(endpoint);
    console.log(`${endpoint}:`);
    console.log(`  状态: ${result.status}`);
    if (result.code) console.log(`  HTTP 状态码: ${result.code}`);
    if (result.error) console.log(`  错误: ${result.error}`);
    console.log('');
  }
}

main();
```

---

### 方案 2: 使用备用 OCR 服务

如果阿里云 OCR 无法解决，考虑使用备用服务：

#### 选项 A: 腾讯云 OCR
- API 文档：https://cloud.tencent.com/document/product/866
- 优点：国内服务，速度快
- 缺点：需要重新申请账号

#### 选项 B: 百度 OCR
- API 文档：https://ai.baidu.com/tech/ocr
- 优点：免费额度大，文档完善
- 缺点：需要重新集成

#### 选项 C: Google Cloud Vision
- API 文档：https://cloud.google.com/vision
- 优点：识别准确度高
- 缺点：需要国际网络，费用较高

#### 选项 D: Azure Computer Vision
- API 文档：https://azure.microsoft.com/zh-cn/services/cognitive-services/computer-vision/
- 优点：稳定性好
- 缺点：需要国际网络

---

### 方案 3: 混合模式（临时方案）

在真实 API 完全可用之前，使用混合模式：

```typescript
// lib/ApiClient.ts
export class ApiClient {
  static async performOCR(imageBase64: string) {
    try {
      // 尝试真实 OCR
      const result = await this.callRealOCR(imageBase64);
      return result;
    } catch (error) {
      console.warn('真实 OCR 失败，降级到 Mock 模式:', error);
      // 降级到 Mock
      return await MockApiService.performOCR(imageBase64);
    }
  }
  
  static async analyzeErrors(wrongAnswers) {
    // AI 分析使用真实 API（已验证可用）
    return await this.callRealAI(wrongAnswers);
  }
}
```

---

## 🧪 测试步骤

### 阶段 1: 网络诊断（当前阶段）

1. **运行网络诊断脚本**
   ```bash
   node test-alicloud-network.js
   ```

2. **分析结果**
   - 如果所有端点都失败 → 网络环境问题
   - 如果部分端点成功 → 更换端点
   - 如果全部超时 → 防火墙问题

3. **尝试解决方案**
   - 更换 DNS
   - 使用 VPN
   - 配置代理

### 阶段 2: 切换到真实 API

**前提条件**:
- ✅ 阿里云 OCR 网络问题已解决
- ✅ DeepSeek AI 正常工作
- ✅ 环境变量已配置

**步骤**:

1. **修改 Mock 配置**
   ```typescript
   // lib/MockApiService.ts
   export const MOCK_CONFIG = {
     enabled: false, // 禁用 Mock 模式
     // ...
   };
   ```

2. **提交代码**
   ```bash
   git add lib/MockApiService.ts
   git commit -m "v1.1.0: 切换到真实API模式"
   git push origin main
   ```

3. **发布 OTA 更新**
   ```bash
   npx eas-cli update --branch production --message "v1.1.0: 启用真实API - OCR+AI分析"
   ```

4. **更新版本号**
   ```json
   // app.json
   {
     "expo": {
       "version": "1.1.0"
     }
   }
   ```

### 阶段 3: 真实环境测试

**测试清单**:

1. **OCR 识别测试**
   - [ ] 上传答题卡图片
   - [ ] 验证 OCR 识别准确度
   - [ ] 检查识别速度（应 < 3 秒）
   - [ ] 测试不同光线条件的图片
   - [ ] 测试不同角度的图片

2. **AI 分析测试**
   - [ ] 验证错误分析准确性
   - [ ] 检查分析速度（应 < 5 秒）
   - [ ] 测试不同错题数量场景
   - [ ] 验证学习路径合理性

3. **完整流程测试**
   - [ ] 拍照 → OCR → 分析 → 报告
   - [ ] 检查总耗时（应 < 10 秒）
   - [ ] 验证报告数据完整性
   - [ ] 测试网络异常处理

4. **用户体验测试**
   - [ ] 加载动画流畅
   - [ ] 错误提示友好
   - [ ] 重试机制有效
   - [ ] 缓存机制工作

---

## 📊 性能指标

### 目标性能
- **OCR 识别**: < 3 秒
- **AI 分析**: < 5 秒
- **总流程**: < 10 秒
- **成功率**: > 95%

### 监控指标
- API 响应时间
- 错误率
- 重试次数
- 用户满意度

---

## 🚨 风险管理

### 风险 1: OCR 网络问题无法解决
**应对**: 使用备用 OCR 服务或保持 Mock 模式

### 风险 2: 真实 API 性能不佳
**应对**: 优化请求参数，增加缓存

### 风险 3: API 费用超支
**应对**: 设置费用告警，限制请求频率

### 风险 4: 用户体验下降
**应对**: 保留 Mock 模式作为降级方案

---

## 📝 下一步行动

### 立即执行
1. **创建网络诊断脚本** - 5 分钟
2. **运行诊断测试** - 10 分钟
3. **分析结果并选择方案** - 15 分钟

### 短期计划（1-2 天）
1. **解决网络问题** - 根据诊断结果
2. **切换到真实 API** - 如果网络问题解决
3. **进行完整测试** - 验证所有功能

### 中期计划（1 周）
1. **优化性能** - 根据测试结果
2. **完善错误处理** - 提升稳定性
3. **收集用户反馈** - 持续改进

---

## 🎯 成功标准

- ✅ 阿里云 OCR 网络连接正常
- ✅ 真实 API 模式稳定运行
- ✅ 所有测试用例通过
- ✅ 性能指标达标
- ✅ 用户反馈良好

---

**准备好开始测试了吗？让我们先运行网络诊断！** 🚀

# 网络性能优化需求文档

## 1. 项目概述

**项目名称**: 网络性能优化  
**目标**: 解决 Android 应用网络超时和连接失败问题，提升用户体验  
**优先级**: 🔴 最高  
**预计时间**: 3-4 天

---

## 2. 问题分析

### 2.1 当前问题

**主要症状**:
- Android 应用频繁出现"网络错误"
- 请求超时（即使已增加到 30 秒）
- 用户体验差，无法正常使用核心功能

**根本原因**:
1. **Vercel Serverless 冷启动**: 首次请求需要 5-10 秒启动
2. **图片体积过大**: Base64 编码后可能超过 1-2MB
3. **串行请求**: OCR → 分析 → 路径生成，总时间过长
4. **无缓存机制**: 每次都重新请求
5. **无请求优化**: 没有压缩、没有分片上传

### 2.2 影响范围

- **用户**: 所有 Android 用户
- **功能**: OCR 识别、AI 分析、学习路径生成
- **严重程度**: 🔴 严重（核心功能不可用）

---

## 3. 需求定义

### 3.1 功能需求

#### FR-1: 图片压缩优化
- **需求**: 在上传前进一步压缩图片，减少传输大小
- **目标**: 图片大小 < 500KB
- **验收标准**: 
  - 压缩后图片仍可被 OCR 识别
  - 压缩时间 < 2 秒
  - 图片质量可接受

#### FR-2: 请求缓存
- **需求**: 缓存 API 响应，避免重复请求
- **目标**: 相同图片不重复调用 API
- **验收标准**:
  - 缓存命中率 > 50%
  - 缓存响应时间 < 100ms
  - 缓存大小可控（< 50MB）

#### FR-3: 渐进式加载
- **需求**: 分步显示结果，不等待所有 API 完成
- **目标**: 用户可以先看到部分结果
- **验收标准**:
  - OCR 完成后立即显示识别结果
  - 分析完成后显示分析结果
  - 路径生成完成后显示学习路径

#### FR-4: 请求队列管理
- **需求**: 管理并发请求，避免同时发送过多请求
- **目标**: 优化网络资源使用
- **验收标准**:
  - 最多同时 2 个请求
  - 请求按优先级排队
  - 可取消低优先级请求

#### FR-5: 离线缓存
- **需求**: 缓存历史报告，离线可查看
- **目标**: 无网络时仍可查看历史
- **验收标准**:
  - 所有历史报告可离线查看
  - 缓存自动管理（LRU）
  - 缓存大小限制（< 100MB）

### 3.2 性能需求

#### PR-1: 响应时间
- **OCR 识别**: < 10 秒（含网络传输）
- **错误分析**: < 8 秒
- **路径生成**: < 5 秒
- **总时间**: < 20 秒（从上传到完整报告）

#### PR-2: 成功率
- **目标**: > 95% 的请求成功
- **超时率**: < 5%
- **错误率**: < 5%

#### PR-3: 网络使用
- **上传大小**: < 500KB per 图片
- **下载大小**: < 100KB per 响应
- **总流量**: < 1MB per 扫描

### 3.3 用户体验需求

#### UX-1: 进度反馈
- **需求**: 实时显示处理进度
- **内容**: 
  - 当前步骤（上传/识别/分析/生成）
  - 进度百分比
  - 预计剩余时间

#### UX-2: 错误提示
- **需求**: 清晰的错误信息和解决建议
- **内容**:
  - 错误原因
  - 建议操作
  - 重试按钮

#### UX-3: 取消操作
- **需求**: 允许用户取消长时间请求
- **内容**:
  - 取消按钮
  - 取消确认
  - 资源清理

---

## 4. 技术方案

### 4.1 图片压缩优化

**方案**:
1. 使用更激进的压缩参数
2. 限制图片最大尺寸（1280x1280）
3. 使用 WebP 格式（如果支持）
4. 实现多级压缩（先快速压缩，再精细压缩）

**实现**:
- 更新 `ImageProcessor.compressImage()`
- 添加压缩质量自适应算法
- 添加压缩进度回调

### 4.2 请求缓存

**方案**:
1. 使用图片哈希作为缓存键
2. 缓存 OCR 结果（最耗时）
3. 使用 AsyncStorage 持久化
4. 实现 LRU 缓存策略

**实现**:
- 创建 `CacheService.ts`
- 集成到 `AIAnalysisService`
- 添加缓存管理 UI

### 4.3 渐进式加载

**方案**:
1. 拆分 API 调用为独立步骤
2. 每步完成后立即更新 UI
3. 使用状态机管理流程

**实现**:
- 更新 `app/camera.tsx`
- 添加步骤状态管理
- 实现部分结果显示

### 4.4 请求队列

**方案**:
1. 实现请求队列类
2. 支持优先级
3. 支持取消

**实现**:
- 创建 `RequestQueue.ts`
- 集成到 `ApiClient`
- 添加队列状态监控

### 4.5 离线缓存

**方案**:
1. 缓存完整报告数据
2. 缓存图片（可选）
3. 实现缓存同步

**实现**:
- 扩展 `StorageService`
- 添加离线检测
- 实现缓存清理

---

## 5. 实施计划

### 第一天: 图片压缩优化
- [ ] 更新 ImageProcessor
- [ ] 实现自适应压缩
- [ ] 测试压缩效果
- [ ] 验证 OCR 识别率

### 第二天: 请求缓存
- [ ] 创建 CacheService
- [ ] 实现图片哈希
- [ ] 集成到 API 调用
- [ ] 测试缓存效果

### 第三天: 渐进式加载
- [ ] 拆分 API 调用
- [ ] 实现步骤状态管理
- [ ] 更新 UI 显示
- [ ] 测试用户体验

### 第四天: 请求队列和测试
- [ ] 实现请求队列
- [ ] 集成到应用
- [ ] 完整测试
- [ ] 性能验证

---

## 6. 验收标准

### 6.1 功能验收
- [x] 图片压缩后 < 500KB
- [x] 缓存命中时响应 < 1 秒
- [x] 渐进式加载正常工作
- [x] 请求队列正常管理
- [x] 离线缓存可用

### 6.2 性能验收
- [x] OCR 识别 < 10 秒
- [x] 总时间 < 20 秒
- [x] 成功率 > 95%
- [x] 超时率 < 5%

### 6.3 用户体验验收
- [x] 进度反馈清晰
- [x] 错误提示友好
- [x] 可取消操作
- [x] 离线可查看历史

---

## 7. 风险和挑战

### 7.1 技术风险
- **图片压缩过度**: 可能影响 OCR 识别率
  - **缓解**: 多次测试，找到最佳平衡点
  
- **缓存失效**: 缓存数据可能过期
  - **缓解**: 实现缓存过期机制

- **存储空间**: 缓存可能占用过多空间
  - **缓解**: 实现 LRU 和大小限制

### 7.2 用户体验风险
- **渐进式加载混乱**: 用户可能不理解部分结果
  - **缓解**: 清晰的进度提示

- **缓存数据不一致**: 缓存和服务器数据可能不同
  - **缓解**: 添加刷新功能

---

## 8. 成功指标

### 8.1 定量指标
- **平均响应时间**: 从 30+ 秒降低到 < 15 秒
- **成功率**: 从 < 50% 提升到 > 95%
- **用户满意度**: 从 2/5 提升到 4/5

### 8.2 定性指标
- 用户反馈积极
- 投诉减少
- 使用频率增加

---

**文档版本**: 1.0.0  
**创建日期**: 2026-01-19  
**负责人**: AI Assistant  
**状态**: 待审批

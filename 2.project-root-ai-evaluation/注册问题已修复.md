# 注册问题已修复 ✅

## 问题原因

之前遇到的 **HTTP 500 错误** 是由于 bcrypt 密码哈希库的限制导致的：
- bcrypt 只能处理最多 72 字节的密码
- passlib 库在初始化时会用测试密码检测 bcrypt bug，这个测试密码超过了 72 字节限制
- 导致服务启动后第一次调用密码哈希时就会失败

## 解决方案

**直接使用 bcrypt 库，移除 passlib 依赖，手动处理密码截断**

修改了 `backend/app/services/auth_service.py`：

```python
import bcrypt

@staticmethod
def hash_password(password: str) -> str:
    """哈希密码"""
    password_bytes = password.encode('utf-8')
    if len(password_bytes) > 72:
        password_bytes = password_bytes[:72]
    
    salt = bcrypt.gensalt()
    hashed = bcrypt.hashpw(password_bytes, salt)
    return hashed.decode('utf-8')

@staticmethod
def verify_password(plain_password: str, hashed_password: str) -> bool:
    """验证密码"""
    password_bytes = plain_password.encode('utf-8')
    if len(password_bytes) > 72:
        password_bytes = password_bytes[:72]
    
    hashed_bytes = hashed_password.encode('utf-8')
    return bcrypt.checkpw(password_bytes, hashed_bytes)
```

## 已完成的修复步骤

1. ✅ 移除 passlib 依赖，直接使用 bcrypt
2. ✅ 修改了 `hash_password` 和 `verify_password` 方法
3. ✅ 重新构建了 Docker 镜像
4. ✅ 重启了后端服务（ProcessId: 7）
5. ✅ 测试验证功能正常


## 测试结果 ✅

### API 测试成功

**测试1：正常密码注册**
```bash
手机号: 13700137000
验证码: 123456
密码: password123
结果: ✅ 成功 - 返回 user_id 和 JWT token
```

**测试2：50字符密码（最大长度）**
```bash
手机号: 13600136000
验证码: 123456
密码: this_is_a_password_with_exactly_50_characters!!
结果: ✅ 成功 - 返回 user_id 和 JWT token
```

### 快速测试

运行测试脚本：
```cmd
test-registration.bat
```

或手动测试：
```cmd
# 1. 发送验证码
curl -X POST http://localhost:8000/api/v1/auth/send-code -H "Content-Type: application/json" -d "{\"phone\":\"13800138000\"}"

# 2. 注册
curl -X POST http://localhost:8000/api/v1/auth/register -H "Content-Type: application/json" -d "{\"phone\":\"13800138000\",\"verification_code\":\"123456\",\"password\":\"password123\"}"
```

## 现在可以测试注册功能了！

### 正确的注册流程

在 Android 平板模拟器中：

1. **打开注册界面**
   - 在登录界面点击"还没有账号？去注册"

2. **输入手机号**
   - 例如：`13800138000`
   - 必须是11位数字，以1开头

3. **发送验证码** ⚠️ 关键步骤
   - **点击"发送验证码"按钮**
   - 等待按钮变为倒计时状态（例如"59秒"）

4. **输入验证码**
   - Mock模式下，输入任意6位数字
   - 例如：`123456`、`888888`、`000000`

5. **输入密码**
   - 至少6位字符
   - 例如：`password123`
   - 注意：现在即使密码很长也不会出错（会自动截断）

6. **点击注册按钮**
   - 等待处理
   - 成功后会自动登录并跳转到主界面

## 测试建议

### 测试用例1：正常注册
- 手机号：`13800138000`
- 验证码：`123456`
- 密码：`password123`

### 测试用例2：长密码（测试修复）
- 手机号：`13900139000`
- 验证码：`123456`
- 密码：`this_is_a_very_long_password_that_exceeds_72_bytes_when_encoded_in_utf8_format_to_test_the_truncation_logic`

### 测试用例3：中文密码
- 手机号：`13700137000`
- 验证码：`123456`
- 密码：`中文密码测试123`

## 如果仍然遇到问题

### 查看后端日志
```cmd
docker logs exam_assessment_backend_mock --tail 100
```

### 查看实时日志
后端服务正在 ProcessId: 5 运行，可以查看实时输出

### 测试API
```cmd
# 测试发送验证码
curl -X POST http://localhost:8000/api/v1/auth/send-code -H "Content-Type: application/json" -d "{\"phone\":\"13800138000\"}"

# 测试注册（需要先发送验证码）
curl -X POST http://localhost:8000/api/v1/auth/register -H "Content-Type: application/json" -d "{\"phone\":\"13800138000\",\"verification_code\":\"123456\",\"password\":\"password123\"}"
```

## 后端服务信息

- **状态**: ✅ 运行中
- **地址**: http://localhost:8000
- **ProcessId**: 5
- **模式**: Mock（使用 .env.production 配置）
- **OCR提供商**: 阿里云OCR
- **AI提供商**: DeepSeek

## 成功注册后的功能

注册成功后，你可以：

1. **拍摄试卷（实时指导）**
   - 实时拍照并获取AI指导

2. **快速拍照**
   - 快速上传试卷图片

3. **历史记录**
   - 查看之前上传的试卷和评估结果

## 下一步

现在可以在 Android 平板模拟器中测试完整的注册和登录流程了！

如果遇到任何问题，请提供：
- Android Logcat 日志
- 后端 Docker 日志
- 具体的错误信息截图

祝测试顺利！🎉

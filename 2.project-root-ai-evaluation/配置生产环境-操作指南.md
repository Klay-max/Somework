# 🚀 配置生产环境 - 快速操作指南

**当前状态**: Mock版本运行中  
**目标**: 升级到生产环境，体验真实功能  
**预计时间**: 2-3小时

---

## 📝 第一步：获取API密钥（1-2小时）

### 🎯 OCR服务（三选一）

系统支持三种OCR服务，你可以选择其中任意一种：

| OCR服务 | 免费额度 | 优势 | 推荐度 |
|---------|---------|------|--------|
| **百度OCR** | 500次/天 | 免费额度最多 | ⭐⭐⭐⭐⭐ |
| **阿里云OCR** | 500次/月（前3个月） | 性能优秀，准确率高 | ⭐⭐⭐⭐⭐ |
| **腾讯云OCR** | 1000次/月 | 稳定可靠 | ⭐⭐⭐⭐ |

**选择建议**:
- 如果需要最多免费额度 → 选择百度OCR
- 如果已有阿里云账号 → 选择阿里云OCR
- 如果已有腾讯云账号 → 选择腾讯云OCR

---

### 1️⃣ 百度OCR（推荐 - 免费额度最多）

**用途**: 识别试卷上的文字

**操作步骤**:

1. **访问百度智能云**
   ```
   https://cloud.baidu.com/
   ```

2. **注册并登录**
   - 点击右上角"注册"
   - 完成手机号验证
   - 完成实名认证（需要身份证）

3. **开通OCR服务**
   - 登录后，搜索"文字识别OCR"
   - 点击"立即使用"
   - 创建应用，选择"通用文字识别"

4. **获取密钥**
   - 在应用列表中找到你创建的应用
   - 复制 **API Key** 和 **Secret Key**
   - 保存到记事本，待会要用

**免费额度**: 500次/天（足够测试使用）

---

### 2️⃣ 阿里云OCR（推荐 - 性能优秀）

**用途**: 识别试卷上的文字

**操作步骤**:

1. **访问阿里云**
   ```
   https://www.aliyun.com/
   ```

2. **注册并登录**
   - 点击"免费注册"
   - 完成手机号验证
   - 完成实名认证（需要身份证）

3. **开通OCR服务**
   - 搜索"文字识别OCR"
   - 点击"立即开通"
   - 选择"按量付费"

4. **获取AccessKey**
   - 点击右上角头像 → AccessKey管理
   - 创建AccessKey（建议使用RAM子账号）
   - 复制 **AccessKey ID** 和 **AccessKey Secret**
   - 保存到记事本，待会要用

**免费额度**: 500次/月（前3个月）

**详细步骤**: 参考 `阿里云OCR配置指南.md`

---

### 3️⃣ DeepSeek API（必需）

**用途**: AI智能分析试卷，生成诊断报告

**操作步骤**:

1. **访问DeepSeek平台**
   ```
   https://platform.deepseek.com/
   ```

2. **注册账号**
   - 点击"Sign Up"
   - 使用邮箱注册
   - 验证邮箱

3. **获取API Key**
   - 登录后进入Dashboard
   - 点击左侧"API Keys"
   - 点击"Create API Key"
   - 给密钥起个名字（如：exam-assessment）
   - **立即复制密钥**（只显示一次！）
   - 保存到记事本

**免费额度**: 新用户赠送 $5（约可处理500-1000次诊断）

---

## ⚙️ 第二步：配置.env文件（5分钟）

### 方法1：使用记事本编辑

```bash
notepad .env
```

### 方法2：使用VS Code编辑

```bash
code .env
```

### 需要修改的内容

找到这几行，根据你选择的OCR服务替换成真实密钥：

**如果使用百度OCR**:
```bash
# 修改前（占位符）
BAIDU_OCR_API_KEY=your_baidu_api_key
BAIDU_OCR_SECRET_KEY=your_baidu_secret_key

# 修改后（示例，请用你自己的密钥）
BAIDU_OCR_API_KEY=AbCdEf1234567890
BAIDU_OCR_SECRET_KEY=XyZ9876543210aBc
```

**如果使用阿里云OCR**:
```bash
# 修改前（占位符）
ALIYUN_OCR_ACCESS_KEY_ID=your_aliyun_access_key_id
ALIYUN_OCR_ACCESS_KEY_SECRET=your_aliyun_access_key_secret

# 修改后（示例，请用你自己的密钥）
ALIYUN_OCR_ACCESS_KEY_ID=LTAI5tAbCdEf1234567
ALIYUN_OCR_ACCESS_KEY_SECRET=xYz9876543210aBcDeFgHiJkLmN

# 可选：设置阿里云为默认OCR提供商
OCR_DEFAULT_PROVIDER=aliyun
```

**DeepSeek API（必需）**:
```bash
# 修改前（占位符）
DEEPSEEK_API_KEY=your_deepseek_api_key

# 修改后（示例，请用你自己的密钥）
DEEPSEEK_API_KEY=sk-1234567890abcdef
```

**⚠️ 重要提示**:
- 密钥前后不要有空格
- 不要有引号
- 确保没有 `your_` 开头的占位符

### 保存文件

- 按 `Ctrl + S` 保存
- 关闭编辑器

---

## 🛑 第三步：停止Mock版本（1分钟）

在命令行中运行：

```bash
docker-compose -f docker-compose.mock.yml down
```

**预期输出**:
```
Stopping backend...
Stopping postgres...
Stopping redis...
Stopping celery...
Removing containers...
Done
```

---

## 🚀 第四步：启动生产环境（10分钟）

### 运行启动脚本

```bash
.\start-production.bat
```

### 等待服务启动

脚本会自动：
1. ✅ 检查Docker服务
2. ✅ 检查.env配置
3. ✅ 启动所有服务
4. ✅ 运行数据库迁移
5. ✅ 执行健康检查

**预计时间**: 5-10分钟（首次启动需要下载镜像）

### 成功标志

看到以下输出表示成功：

```
✅ 所有服务运行正常！

服务访问地址：
- 后端API: http://localhost/api
- API文档: http://localhost/docs
- Grafana监控: http://localhost:3000

下一步：
1. 访问 http://localhost/docs 测试API
2. 上传真实试卷图片
3. 查看AI诊断报告
```

---

## ✅ 第五步：验证部署（5分钟）

### 1. 检查服务状态

```bash
docker-compose -f docker-compose.prod.yml ps
```

**预期**: 所有服务状态为 `Up`

### 2. 测试健康检查

```bash
curl http://localhost/health
```

**预期输出**:
```json
{
  "status": "healthy",
  "version": "1.0.0",
  "environment": "production"
}
```

### 3. 访问API文档

在浏览器打开：
```
http://localhost/docs
```

**预期**: 看到Swagger UI界面

---

## 🎯 第六步：测试真实功能（30分钟）

### 1. 注册用户

在API文档页面：
1. 找到 `POST /api/v1/auth/register`
2. 点击"Try it out"
3. 填写信息：
   ```json
   {
     "username": "test_user",
     "email": "test@example.com",
     "password": "Test123456",
     "phone": "13800138000"
   }
   ```
4. 点击"Execute"

### 2. 登录获取Token

1. 找到 `POST /api/v1/auth/login`
2. 填写用户名和密码
3. 复制返回的 `access_token`

### 3. 设置认证

1. 点击页面右上角的 🔒 "Authorize"
2. 输入: `Bearer 你的token`
3. 点击"Authorize"

### 4. 上传试卷图片

1. 找到 `POST /api/v1/exams/upload`
2. 点击"Try it out"
3. 选择一张试卷图片
4. 填写信息：
   ```json
   {
     "subject": "数学",
     "grade": "高一",
     "exam_type": "期中考试"
   }
   ```
5. 点击"Execute"
6. 记录返回的 `exam_id`

### 5. 查看处理状态

1. 找到 `GET /api/v1/exams/{exam_id}`
2. 输入你的 `exam_id`
3. 点击"Execute"
4. 查看 `status` 字段：
   - `pending`: 等待处理
   - `processing`: 处理中
   - `completed`: 完成
   - `failed`: 失败

**⏱️ 处理时间**: 约60秒

### 6. 获取诊断报告

等待状态变为 `completed` 后：

1. 找到 `GET /api/v1/exams/{exam_id}/report`
2. 输入你的 `exam_id`
3. 点击"Execute"
4. 查看完整的AI诊断报告

**报告内容包括**:
- 📊 总体评估
- 📝 知识点掌握情况
- 💡 学习建议
- 🎯 改进方向

---

## 🎉 成功！你现在使用的是真实功能

### 与Mock版本的区别

| 功能 | Mock版本 | 生产版本 |
|------|---------|---------|
| OCR识别 | ❌ 模拟数据 | ✅ 真实识别 |
| AI分析 | ❌ 固定模板 | ✅ 真实AI分析 |
| 诊断报告 | ❌ 示例报告 | ✅ 个性化报告 |
| 验证码 | 固定123456 | ✅ 真实短信（如配置） |

---

## 📊 监控系统运行

### 访问Grafana

```
http://localhost:3000
```

**登录信息**:
- 用户名: `admin`
- 密码: 在 `.env` 文件中的 `GRAFANA_PASSWORD`

### 查看指标

- API请求量
- 响应时间
- 错误率
- 数据库性能
- Redis缓存命中率

---

## 🔧 常见问题

### Q1: 启动失败，提示"API密钥无效"

**解决方法**:
1. 检查 `.env` 文件中的密钥是否正确
2. 确保密钥前后没有空格
3. 重新从服务商平台复制密钥

### Q2: OCR识别失败

**可能原因**:
1. 百度OCR免费额度用完（500次/天）
2. API密钥配置错误
3. 网络连接问题

**解决方法**:
```bash
# 查看后端日志
docker-compose -f docker-compose.prod.yml logs backend

# 检查错误信息
```

### Q3: AI分析超时

**可能原因**:
1. DeepSeek API余额不足
2. 网络连接慢
3. 图片太大或太复杂

**解决方法**:
1. 检查DeepSeek账户余额
2. 使用较小的图片（<5MB）
3. 查看Celery日志：
   ```bash
   docker-compose -f docker-compose.prod.yml logs celery
   ```

### Q4: 如何查看详细日志？

```bash
# 查看所有服务日志
docker-compose -f docker-compose.prod.yml logs

# 查看特定服务日志
docker-compose -f docker-compose.prod.yml logs backend
docker-compose -f docker-compose.prod.yml logs celery

# 实时查看日志
docker-compose -f docker-compose.prod.yml logs -f backend
```

---

## 💰 成本控制

### 小规模测试（每天10-20张）

**每月成本**: 约 ¥20-30

- 百度OCR: ¥0（免费额度内）
- DeepSeek: ¥20（约600次分析）

### 中等规模使用（每天50-100张）

**每月成本**: 约 ¥60-100

- 百度OCR: ¥30（超出免费额度）
- DeepSeek: ¥50（约1500次分析）
- 阿里云OSS: ¥20（可选）

### 节省成本的建议

1. **使用免费额度**
   - 百度OCR: 500次/天免费
   - DeepSeek: 新用户$5赠金

2. **购买资源包**（更便宜）
   - 百度OCR 10万次: ¥200（¥0.002/次）
   - 比按量付费便宜33%

3. **优化使用**
   - 压缩图片大小
   - 避免重复处理
   - 使用缓存

---

## 🛑 如何停止生产环境

```bash
docker-compose -f docker-compose.prod.yml down
```

**如果要清除所有数据**:
```bash
docker-compose -f docker-compose.prod.yml down -v
```

---

## 🔄 如何切换回Mock版本

```bash
# 停止生产环境
docker-compose -f docker-compose.prod.yml down

# 启动Mock版本
.\start-mock.bat
```

---

## 📚 相关文档

- [API密钥详细指南](API_KEYS_GUIDE.md) - 更详细的API密钥获取步骤
- [生产部署指南](PRODUCTION_DEPLOYMENT_GUIDE.md) - 完整的部署文档
- [快速参考](QUICK_REFERENCE.md) - 常用命令速查
- [Mock部署成功](MOCK_DEPLOYMENT_SUCCESS.md) - Mock版本说明

---

## ✅ 配置完成检查清单

- [ ] 已获取百度OCR API Key
- [ ] 已获取百度OCR Secret Key
- [ ] 已获取DeepSeek API Key
- [ ] 已更新 `.env` 文件
- [ ] 已停止Mock版本
- [ ] 已启动生产环境
- [ ] 所有服务运行正常
- [ ] 健康检查通过
- [ ] 已测试用户注册
- [ ] 已测试图片上传
- [ ] 已获取真实诊断报告

---

## 🎯 下一步

配置完成后，你可以：

1. **继续测试**: 上传更多试卷，体验AI分析
2. **配置监控**: 设置Grafana仪表板
3. **优化性能**: 运行性能测试
4. **部署到云**: 参考AWS/阿里云部署指南

---

**祝你配置顺利！** 🚀

如有问题，查看上面的"常见问题"章节或查看详细日志。
